{{page-title "Permit Review - Municipal Portal"}}

<div class="permit-view municipal-permit-view">
  {{#if @model.error}}
    <div class="error-state">
      <div class="error-icon">‚ö†Ô∏è</div>
      <h2>Error Loading Permit</h2>
      <p>{{@model.error}}</p>
      <button type="button" class="btn btn-primary" {{on "click" this.goBack}}>
        ‚Üê Back to Dashboard
      </button>
    </div>
  {{else if @model.permit}}
    {{!-- Compact Professional Header --}}
    <div class="permit-header-compact">
      <div class="header-layout">
        {{!-- Left: Back Button --}}
        <div class="header-left">
          <button type="button" class="btn btn-outline-secondary btn-sm" {{on "click" this.goBack}}>
            ‚Üê Back
          </button>
        </div>

        {{!-- Center: Permit Info --}}
        <div class="header-center">
          <h1 class="permit-number">{{@model.permit.permitNumber}}</h1>
          <span class="permit-details">
            {{@model.permit.type}} ‚Ä¢ 
            <span class="status-badge {{get-status-badge-class @model.permit.status}}">
              {{this.formatStatus @model.permit.status}}
            </span>
          </span>
        </div>

        {{!-- Right: Municipal Actions --}}
        <div class="header-right">
          {{#if (eq @model.permit.status "submitted")}}
            <button type="button" class="btn btn-primary btn-sm me-2" {{on "click" this.approvePermit}}>
              üìã Start Review
            </button>
            <button type="button" class="btn btn-warning btn-sm me-2" {{on "click" this.requestChanges}}>
              ‚Üª Changes
            </button>
            <button type="button" class="btn btn-danger btn-sm" {{on "click" this.denyPermit}}>
              ‚úó Deny
            </button>
          {{else if (eq @model.permit.status "approved")}}
            <button type="button" class="btn btn-primary btn-sm me-2" {{on "click" this.sendToInspections}}>
              üîç Inspections
            </button>
            <button type="button" class="btn btn-secondary btn-sm" {{on "click" this.markCompleted}}>
              ‚úì Complete
            </button>
          {{else if (eq @model.permit.status "inspection-requested")}}
            <button type="button" class="btn btn-primary btn-sm me-2" {{on "click" this.scheduleInspection}}>
              üìÖ Schedule
            </button>
          {{else if (eq @model.permit.status "inspections")}}
            <button type="button" class="btn btn-success btn-sm me-2" {{on "click" this.passInspection}}>
              ‚úì Pass
            </button>
            <button type="button" class="btn btn-outline-primary btn-sm" {{on "click" this.editPermit}}>
              ‚úèÔ∏è Edit
            </button>
          {{else}}
            <button type="button" class="btn btn-outline-primary btn-sm" {{on "click" this.editPermit}}>
              ‚úèÔ∏è Edit
            </button>
          {{/if}}
        </div>
      </div>
    </div>

    {{!-- Horizontal Review Process Timeline (Sticky) --}}
    <HorizontalTimeline @steps={{@model.permit.reviewProcess.steps}} @class="sticky" />


    <div class="permit-content">
      {{!-- Municipal Department Review Section --}}
      {{#if (eq @model.permit.status "under-review")}}
        <div class="department-reviews-container">
          {{!-- Status Message Area --}}
          <div class="approval-status-message" style="display: none; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 0.375rem; padding: 0.75rem; margin-bottom: 1rem; font-size: 0.875rem; color: #6c757d;"></div>
          
          <section class="details-card">
            <div class="department-header">
              <h3>Department Reviews</h3>
              <button type="button" class="btn btn-sm btn-outline-primary" {{on "click" this.loadDepartmentReviews}}>
                üîÑ Refresh
              </button>
            </div>
            <div class="details-content">
              {{#if this.departmentReviews}}
                {{#if this.departmentReviews.departmentReviews.length}}
                  <div class="department-reviews-grid">
                    {{#each this.departmentReviews.departmentReviews as |review|}}
                      <div class="department-review-item">
                        <div class="review-header">
                          <span class="department-name">{{this.formatDepartmentName review.department}}</span>
                          <span class="status-badge {{this.getReviewStatusClass review.status}}">
                            {{this.formatReviewStatus review.status}}
                          </span>
                        </div>
                        {{#if review.reviewer.name}}
                          <div class="reviewer-info">{{review.reviewer.name}}</div>
                        {{/if}}
                        {{#if review.notes}}
                          <div class="review-notes">{{review.notes}}</div>
                        {{/if}}
                      </div>
                    {{/each}}
                  </div>
                {{/if}}

                {{!-- User Review Panel --}}
                {{#if this.canUserReviewPermit}}
                  <div class="user-review-panel">
                    <h6>Review for {{this.formatDepartmentName this.currentUser.department}} Department</h6>
                    <button type="button" class="btn btn-primary btn-sm" {{on "click" this.openApprovalModal}}>
                      üìã Complete Department Review
                    </button>
                  </div>
                {{/if}}
              {{/if}}
            </div>
          </section>
        </div>
      {{/if}}

      {{!-- Review Process and Chat Side by Side --}}
      <div class="review-and-chat-container">
        
        {{!-- Municipal Staff Communication - Side by Side Layout --}}
        <section class="permit-messaging municipal-messaging">
          <div class="messaging-panels-container">
            
            {{!-- Internal Messages Panel --}}
            <div class="messaging-panel internal-panel">
              <div class="panel-header">
                <h6>Internal Notes</h6>
                <small>Municipal staff only</small>
              </div>
              <div class="messages-container" id="internal-messages">
                {{#each this.internalMessages as |message|}}
                  <div class="message {{if (eq message.senderId this.currentUserId) 'own' 'other'}}">
                    <div class="message-info">
                      <strong>{{message.senderName}}</strong>
                      <small>{{this.formatDateTime message.createdAt}}</small>
                    </div>
                    <div class="message-text">{{message.content}}</div>
                  </div>
                {{/each}}
              </div>
              <div class="message-input">
                <div class="input-group">
                  <input 
                    type="text" 
                    class="form-control" 
                    placeholder="Add internal note..."
                    value={{this.internalMessage}}
                    {{on "input" this.updateInternalMessage}}
                    {{on "keyup" this.handleInternalKeyup}}
                  />
                  <button 
                    type="button" 
                    class="btn btn-primary"
                    {{on "click" this.sendInternalMessage}}
                    disabled={{not this.internalMessage.length}}
                  >
                    Send
                  </button>
                </div>
              </div>
            </div>

            {{!-- Public Communication Panel --}}
            <div class="messaging-panel public-panel">
              <div class="panel-header">
                <h6>Communication</h6>
                <small>Visible to applicant</small>
              </div>
              <div class="messages-container" id="public-messages">
                {{#each this.publicMessages as |message|}}
                  <div class="message {{if (eq message.senderId this.currentUserId) 'own' 'other'}}">
                    <div class="message-info">
                      <strong>{{message.senderName}}</strong>
                      <small>{{this.formatDateTime message.createdAt}}</small>
                    </div>
                    <div class="message-text">{{message.content}}</div>
                  </div>
                {{/each}}
              </div>
              <div class="message-input">
                <div class="input-group">
                  <input 
                    type="text" 
                    class="form-control" 
                    placeholder="Message applicant..."
                    value={{this.publicMessage}}
                    {{on "input" this.updatePublicMessage}}
                    {{on "keyup" this.handlePublicKeyup}}
                  />
                  <button 
                    type="button" 
                    class="btn btn-primary"
                    {{on "click" this.sendPublicMessage}}
                    disabled={{not this.publicMessage.length}}
                  >
                    Send
                  </button>
                </div>
              </div>
            </div>
            
          </div>
        </section>
      </div>

      {{!-- File Management Section --}}
      <div class="file-management-container">
        <section class="file-display-section">
          <PermitFilesDisplay 
            @permitId={{@model.permit.id}}
            @onFileDeleted={{this.handleFileDeleted}}
            @onMount={{this.setFilesDisplayComponent}}
            @onUploadClick={{this.showFileUploadModal}}
          />
        </section>
      </div>

      {{!-- Permit Details Grid --}}
      <div class="permit-details-grid">
        {{!-- Project Information --}}
        <section class="details-card">
          <h3>Project Information</h3>
          <div class="details-content">
            <div class="detail-item">
              <span class="detail-label">Type:</span>
              <span class="detail-value">{{@model.permit.type}}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Description:</span>
              <span class="detail-value">{{@model.permit.description}}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Estimated Value:</span>
              <span class="detail-value">{{format-currency @model.permit.projectValue}}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Municipality:</span>
              <span class="detail-value">{{@model.permit.municipality}}</span>
            </div>
          </div>
        </section>

        {{!-- Application Information --}}
        <section class="details-card">
          <h3>Application Information</h3>
          <div class="details-content">
            <div class="detail-item">
              <span class="detail-label">Submitted:</span>
              <span class="detail-value">{{format-date @model.permit.submittedDate}}</span>
            </div>
            {{#if @model.permit.approvedDate}}
              <div class="detail-item">
                <span class="detail-label">Approved:</span>
                <span class="detail-value">{{format-date @model.permit.approvedDate}}</span>
              </div>
            {{/if}}
            {{#if @model.permit.expiryDate}}
              <div class="detail-item">
                <span class="detail-label">Expires:</span>
                <span class="detail-value">{{format-date @model.permit.expiryDate}}</span>
              </div>
            {{/if}}
            <div class="detail-item">
              <span class="detail-label">Application Fee:</span>
              <span class="detail-value">{{format-currency @model.permit.fee}}</span>
            </div>
          </div>
        </section>

        {{!-- Property Information --}}
        {{#if @model.permit.property}}
          <section class="details-card">
            <h3>Property Information</h3>
            <div class="details-content">
              {{#if @model.permit.property.displayName}}
                <div class="detail-item">
                  <span class="detail-label">Property:</span>
                  <span class="detail-value">{{@model.permit.property.displayName}}</span>
                </div>
              {{/if}}
              {{#if @model.permit.property.address}}
                <div class="detail-item">
                  <span class="detail-label">Address:</span>
                  <span class="detail-value">
                    {{@model.permit.property.address.street}}<br>
                    {{@model.permit.property.address.city}}, {{@model.permit.property.address.state}} {{@model.permit.property.address.zip}}
                  </span>
                </div>
              {{/if}}
            </div>
          </section>
        {{/if}}

        {{!-- Applicant Information --}}
        {{#if @model.permit.applicant}}
          <section class="details-card">
            <h3>Applicant Information</h3>
            <div class="details-content">
              <div class="detail-item">
                <span class="detail-label">Name:</span>
                <span class="detail-value">{{@model.permit.applicant.firstName}} {{@model.permit.applicant.lastName}}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Email:</span>
                <span class="detail-value">{{@model.permit.applicant.email}}</span>
              </div>
              {{#if @model.permit.applicant.phone}}
                <div class="detail-item">
                  <span class="detail-label">Phone:</span>
                  <span class="detail-value">{{@model.permit.applicant.phone}}</span>
                </div>
              {{/if}}
              <div class="detail-item">
                <span class="detail-label">Type:</span>
                <span class="detail-value">{{capitalize @model.permit.applicant.type}}</span>
              </div>
            </div>
          </section>
        {{/if}}

        {{!-- Contractor Information --}}
        {{#if @model.permit.contractor}}
          <section class="details-card">
            <h3>Contractor Information</h3>
            <div class="details-content">
              <div class="detail-item">
                <span class="detail-label">Business:</span>
                <span class="detail-value">{{@model.permit.contractor.businessName}}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Contact:</span>
                <span class="detail-value">{{@model.permit.contractor.firstName}} {{@model.permit.contractor.lastName}}</span>
              </div>
              {{#if @model.permit.contractor.licenseNumber}}
                <div class="detail-item">
                  <span class="detail-label">License:</span>
                  <span class="detail-value">{{@model.permit.contractor.licenseNumber}}</span>
                </div>
              {{/if}}
              {{#if @model.permit.contractor.phone}}
                <div class="detail-item">
                  <span class="detail-label">Phone:</span>
                  <span class="detail-value">{{@model.permit.contractor.phone}}</span>
                </div>
              {{/if}}
              {{#if @model.permit.contractor.email}}
                <div class="detail-item">
                  <span class="detail-label">Email:</span>
                  <span class="detail-value">{{@model.permit.contractor.email}}</span>
                </div>
              {{/if}}
            </div>
          </section>
        {{/if}}
      </div>

      {{!-- Additional Information --}}
      {{#if @model.permit.customFields.additionalInfo}}
        <section class="additional-info">
          <h3>Additional Information</h3>
          <div class="info-content">
            <p>{{@model.permit.customFields.additionalInfo}}</p>
          </div>
        </section>
      {{/if}}
    </div>
  {{else}}
    <div class="loading-state">
      <div class="loading-spinner"></div>
      <p>Loading permit details...</p>
    </div>
  {{/if}}
</div>

{{!-- Edit Permit Modal --}}
{{#if this.showEditModal}}
  <div class="modal-overlay" {{on "click" this.closeEditModal}}>
    <div class="modal-dialog permit-edit-modal" {{on "click" this.preventModalClose}}> {{! Prevent modal close when clicking inside}}
      <div class="modal-header">
        <h3 class="modal-title">Edit Permit</h3>
        <button type="button" class="modal-close-btn" {{on "click" this.closeEditModal}}>√ó</button>
      </div>

      <div class="modal-body">
        <form {{on "submit" this.savePermitChanges}}>
          
          {{!-- Status Change Section --}}
          <div class="edit-section">
            <h4 class="section-title">Status Management</h4>
            <div class="form-group">
              <label for="edit-status" class="form-label">Permit Status</label>
              <select 
                id="edit-status" 
                class="form-control" 
                value={{this.editingStatus}} 
                {{on "change" this.updateEditingStatus}}
              >
                {{#each this.availableStatuses as |statusOption|}}
                  <option value={{statusOption.value}}>
                    {{statusOption.label}} {{#if statusOption.description}}- {{statusOption.description}}{{/if}}
                  </option>
                {{/each}}
              </select>
              {{#if (not (eq this.editingStatus @model.permit.status))}}
                <small class="form-help text-info">
                  Status will change from "{{this.formatStatus @model.permit.status}}" to "{{this.formatStatus this.editingStatus}}"
                </small>
              {{/if}}
            </div>
          </div>

          {{!-- Department Review Management --}}
          {{#if this.departmentReviews}}
            {{#if this.departmentReviewsToReset.length}}
              <div class="edit-section">
                <h4 class="section-title">Department Review Management</h4>
                <p class="section-description">Reset department reviews to allow re-evaluation</p>
                
                <div class="department-reset-grid">
                  {{#each this.departmentReviewsToReset as |review|}}
                    <label class="department-checkbox">
                      <input 
                        type="checkbox" 
                        checked={{includes this.selectedDepartmentsToReset review.department}}
                        {{on "change" (fn this.toggleDepartmentForReset review.department)}}
                      >
                      <div class="department-checkbox-content">
                        <span class="department-name">{{this.formatDepartmentName review.department}}</span>
                        <span class="department-status {{this.getReviewStatusClass review.status}}">
                          {{this.formatReviewStatus review.status}}
                        </span>
                        {{#if review.reviewer.name}}
                          <small class="reviewer-info">by {{review.reviewer.name}}</small>
                        {{/if}}
                      </div>
                    </label>
                  {{/each}}
                </div>

                {{#if this.selectedDepartmentsToReset.length}}
                  <div class="reset-summary">
                    <strong>{{this.selectedDepartmentsToReset.length}} department(s) will be reset to "Pending Review"</strong>
                    <ul class="reset-list">
                      {{#each this.selectedDepartmentsToReset as |dept|}}
                        <li>{{this.formatDepartmentName dept}}</li>
                      {{/each}}
                    </ul>
                  </div>
                {{/if}}
              </div>
            {{else}}
              <div class="edit-section">
                <h4 class="section-title">Department Review Management</h4>
                <p class="section-description text-muted">No department reviews available to reset. All departments are currently pending review.</p>
              </div>
            {{/if}}
          {{else}}
            <div class="edit-section">
              <h4 class="section-title">Department Review Management</h4>
              <p class="section-description text-muted">Loading department reviews...</p>
            </div>
          {{/if}}

          {{!-- Bulk Actions --}}
          {{#if this.departmentReviewsToReset.length}}
            <div class="edit-section">
              <h4 class="section-title">Quick Actions</h4>
              <div class="bulk-actions">
                <button 
                  type="button" 
                  class="btn btn-outline-warning btn-sm"
                  {{on "click" this.selectAllDepartments}}
                >
                  Select All Departments
                </button>
                <button 
                  type="button" 
                  class="btn btn-outline-secondary btn-sm"
                  {{on "click" this.clearDepartmentSelection}}
                >
                  Clear Selection
                </button>
              </div>
            </div>
          {{/if}}

          {{!-- Notes Section --}}
          <div class="edit-section">
            <h4 class="section-title">Change Notes</h4>
            <div class="form-group">
              <label for="edit-notes" class="form-label">Internal Notes</label>
              <textarea 
                id="edit-notes"
                class="form-control" 
                rows="3"
                placeholder="Add notes about these changes (will be recorded in permit history)..."
                value={{this.editingNotes}}
                {{on "input" this.updateEditingNotes}}
              ></textarea>
              <small class="form-help">These notes will be added to the permit's internal communication log.</small>
            </div>
          </div>

        </form>
      </div>

      <div class="modal-footer">
        <button 
          type="button" 
          class="btn btn-secondary"
          {{on "click" this.closeEditModal}}
        >
          Cancel
        </button>
        <button 
          type="button" 
          class="btn btn-primary"
          {{on "click" this.savePermitChanges}}
          disabled={{this.isSubmitting}}
        >
          {{#if this.isSubmitting}}
            <span class="spinner-border spinner-border-sm me-2"></span>
            Saving...
          {{else}}
            Save Changes
          {{/if}}
        </button>
      </div>
    </div>
  </div>
{{/if}}

{{!-- Permit Approval Modal --}}
<PermitApprovalModal 
  @isOpen={{this.showApprovalModal}}
  @permit={{@model.permit}}
  @currentUser={{this.currentUser}}
  @onClose={{this.closeApprovalModal}}
  @onApproval={{this.handleApproval}}
  @onRejection={{this.handleRejection}}
/>