{{page-title "Permits Management - Municipal Portal"}}

<div class="permits-page">
  <div class="container">
    {{!-- Header --}}
    <div class="page-header mb-4">
      <div class="row items-center">
        <div class="col-md-8">
          <h1 class="text-primary mb-2">Permits Management</h1>
          <p class="text-muted">Review and manage permit applications for {{@model.municipality.name}}</p>
        </div>
        <div class="col-md-4 text-right">
          <div class="d-flex justify-content-end">
            <button type="button" class="btn btn-outline-primary me-2" {{on "click" this.exportPermits}}>
              Export Data
            </button>
            <button type="button" class="btn btn-primary" {{on "click" this.viewDashboard}}>
              Dashboard
            </button>
          </div>
        </div>
      </div>
    </div>

    {{!-- Filter and Search Controls --}}
    <div class="permits-controls mb-4">
      <div class="row">
        <div class="col-md-8">
          <div class="search-box">
            <input 
              type="text" 
              class="form-control" 
              placeholder="Search by permit number, applicant name, or description..."
              value={{@model.searchTerm}}
              {{on "input" this.updateSearchTerm}}
              {{on "keyup" this.handleSearchKeyup}}
            />
            <div class="search-icon">üîç</div>
          </div>
        </div>
        <div class="col-md-4">
          <select class="form-select" {{on "change" this.filterByStatus}} value={{@model.selectedStatus}}>
            <option value="all">All Permits</option>
            <option value="submitted">Submitted</option>
            <option value="under-review">Under Review</option>
            <option value="approved">Approved</option>
            <option value="active">Active</option>
            <option value="inspections">Inspections</option>
            <option value="completed">Completed</option>
            <option value="denied">Denied</option>
            <option value="expired">Expired</option>
          </select>
        </div>
      </div>
    </div>

    {{!-- Permits Summary Cards --}}
    <div class="permits-summary mb-5">
      <div class="summary-cards">
        <div class="summary-card compact" {{on "click" (fn this.filterByStatus "submitted")}}>
          <p class="card-label">Submitted</p>
          <h3 class="card-number">{{@model.permits.submitted.length}}</h3>
        </div>
        <div class="summary-card compact" {{on "click" (fn this.filterByStatus "under-review")}}>
          <p class="card-label">Under Review</p>
          <h3 class="card-number">{{@model.permits.under-review.length}}</h3>
        </div>
        <div class="summary-card compact" {{on "click" (fn this.filterByStatus "approved")}}>
          <p class="card-label">Approved</p>
          <h3 class="card-number">{{@model.permits.approved.length}}</h3>
        </div>
        <div class="summary-card compact" {{on "click" (fn this.filterByStatus "inspections")}}>
          <p class="card-label">Inspections</p>
          <h3 class="card-number">{{@model.permits.inspections.length}}</h3>
        </div>
        <div class="summary-card compact" {{on "click" (fn this.filterByStatus "completed")}}>
          <p class="card-label">Completed</p>
          <h3 class="card-number">{{@model.permits.completed.length}}</h3>
        </div>
      </div>
    </div>

    {{!-- Error State --}}
    {{#if @model.error}}
      <div class="alert alert-danger mb-4">
        <strong>Error loading permits:</strong> {{@model.error}}
        <button type="button" class="btn btn-sm btn-outline-danger ms-2" {{on "click" this.retryLoad}}>
          Retry
        </button>
      </div>
    {{/if}}

    {{!-- Permits Table/Grid --}}
    {{#if @model.permits.all.length}}
      <div class="permits-list">
        <div class="list-header mb-3">
          <h3>
            {{#if (eq @model.selectedStatus "all")}}
              All Permits ({{if @model.permits.all @model.permits.all.length 0}})
            {{else}}
              {{this.formatStatus @model.selectedStatus}} Permits ({{get (get @model.permits @model.selectedStatus) "length"}})
            {{/if}}
          </h3>
        </div>

        <div class="permits-table-wrapper">
          <table class="table table-sm table-hover permits-table">
            <thead class="table-light">
              <tr>
                <th width="15%">Permit #</th>
                <th width="20%">Applicant & Type</th>
                <th width="25%">Project Details</th>
                <th width="12%">Status</th>
                <th width="12%">Submitted</th>
                <th width="8%">Value</th>
                <th width="8%">Actions</th>
              </tr>
            </thead>
            <tbody>
              {{#each (if (eq @model.selectedStatus "all") @model.permits.all (get @model.permits @model.selectedStatus)) as |permit|}}
                <tr class="permit-row cursor-pointer" {{on "click" (fn this.viewPermit permit.id)}}>
                  <td>
                    <div class="permit-number">
                      <strong class="text-primary">{{permit.permitNumber}}</strong>
                    </div>
                  </td>
                  <td>
                    <div class="applicant-summary">
                      <div class="fw-semibold text-dark">{{permit.applicant.name}}</div>
                      <small class="text-muted">{{permit.type}}</small>
                    </div>
                  </td>
                  <td>
                    <div class="project-summary">
                      <div class="project-desc text-truncate" title="{{permit.description}}">
                        {{permit.description}}
                      </div>
                      {{#if permit.property.street}}
                        <small class="text-muted">{{permit.property.street}}, {{permit.property.city}}</small>
                      {{/if}}
                    </div>
                  </td>
                  <td>
                    <span class="badge status-badge-{{permit.status}} rounded-pill">
                      {{this.formatStatus permit.status}}
                    </span>
                  </td>
                  <td>
                    <div class="date-info">
                      <div>{{this.formatDate permit.submittedDate}}</div>
                      <small class="text-muted">{{this.getDaysAgo permit.submittedDate}}d ago</small>
                    </div>
                  </td>
                  <td>
                    <span class="fw-semibold">${{this.formatCurrency permit.projectValue}}</span>
                  </td>
                  <td>
                    <div class="action-buttons">
                      {{#if (eq permit.status "submitted")}}
                        <button 
                          type="button" 
                          class="btn btn-sm btn-primary"
                          title="Review Application"
                          {{on "click" (fn this.reviewPermit permit.id)}}
                          {{on "click" (fn this.stopPropagation)}}
                        >
                          Review
                        </button>
                      {{else}}
                        <button 
                          type="button" 
                          class="btn btn-sm btn-outline-secondary"
                          title="View Details"
                          {{on "click" (fn this.viewPermit permit.id)}}
                          {{on "click" (fn this.stopPropagation)}}
                        >
                          View
                        </button>
                      {{/if}}
                    </div>
                  </td>
                </tr>
              {{/each}}
            </tbody>
          </table>
        </div>
      </div>
    {{else}}
      {{!-- Empty State --}}
      <div class="empty-state text-center p-5">
        <div class="empty-icon mb-3">üìã</div>
        <h3 class="text-muted mb-3">
          {{#if @model.searchTerm}}
            No permits match your search
          {{else if (not (eq @model.selectedStatus "all"))}}
            No {{@model.selectedStatus}} permits found
          {{else}}
            No permits submitted yet
          {{/if}}
        </h3>
        <p class="text-muted mb-4">
          {{#if @model.searchTerm}}
            Try adjusting your search terms or clearing the filter.
          {{else if (not (eq @model.selectedStatus "all"))}}
            No permits with status "{{@model.selectedStatus}}" have been submitted yet.
          {{else}}
            No permit applications have been submitted to your municipality yet.
          {{/if}}
        </p>
        {{#if @model.searchTerm}}
          <button type="button" class="btn btn-outline-primary" {{on "click" this.clearSearch}}>
            Clear Search
          </button>
        {{/if}}
      </div>
    {{/if}}
  </div>
</div>