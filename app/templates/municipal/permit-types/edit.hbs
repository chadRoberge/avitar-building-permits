{{page-title "Edit Permit Type - Municipal Portal"}}

<div class="permit-type-form-container">
  <header class="form-header">
    <div class="header-content">
      <h1>Edit Permit Type</h1>
      <p>Update permit configuration and application questions</p>
    </div>
    <div class="header-actions">
      <LinkTo @route="municipal.permit-types.index" class="btn btn-secondary">
        <span class="btn-icon">←</span>
        Back to Permit Types
      </LinkTo>
    </div>
  </header>

  <form class="permit-type-form" {{on "submit" this.updatePermitType}}>
    {{! Step 1: Current Category Information }}
    <div class="form-section">
      <div class="section-header">
        <h2>1. Permit Category</h2>
        <p>This permit type belongs to the following category</p>
      </div>

      <div class="current-category">
        <div class="category-display">
          <div class="category-icon">{{this.selectedCategoryInfo.icon}}</div>
          <div class="category-content">
            <h3 class="category-name">{{this.selectedCategoryInfo.name}}</h3>
            <p class="category-description">{{this.selectedCategoryInfo.description}}</p>
          </div>
          <div class="category-badge">
            <span class="badge-text">Current Category</span>
          </div>
        </div>
        <p class="category-note">
          <strong>Note:</strong> The permit category cannot be changed after creation. 
          If you need a different category, please create a new permit type.
        </p>
      </div>
    </div>

    {{! Step 2: Configure Basic Settings }}
    <div class="form-section">
      <div class="section-header">
        <h2>2. Basic Configuration</h2>
        <p>Update permit details and settings</p>
      </div>

      <div class="form-grid">
        <div class="form-group">
          <label for="permit-name">Permit Name</label>
          <Input id="permit-name" @value={{this.permitName}} required />
          <small class="form-help">This will be displayed to applicants</small>
        </div>

        <div class="form-group">
          <label for="permit-code">Permit Code</label>
          <Input id="permit-code" @value={{this.permitCode}} required />
          <small class="form-help">Short code for internal reference (e.g., BP, ZP, EP)</small>
        </div>

        <div class="form-group">
          <label for="base-fee">Base Fee ($)</label>
          <Input id="base-fee" @type="number" @value={{this.baseFee}} placeholder="0.00" step="0.01" min="0" />
          <small class="form-help">Base application fee (always charged)</small>
        </div>

        <div class="form-group">
          <label for="additional-fee-structure">Additional Fee Structure</label>
          <select id="additional-fee-structure" class="form-select" value={{this.feeStructureType}} {{on "change" this.handleFeeStructureChange}}>
            <option value="none">No Additional Fees</option>
            <option value="percentage">Percentage of Project Value</option>
            <option value="square_footage">Per Square Foot</option>
            <option value="tiered">Tiered Based on Value</option>
          </select>
          <small class="form-help">Additional fees on top of base fee</small>
        </div>

        {{#if (eq this.feeStructureType "percentage")}}
          <div class="form-group">
            <label for="fee-percentage">Percentage (%)</label>
            <Input id="fee-percentage" @type="number" @value={{this.feePercentage}} placeholder="1.5" step="0.1" min="0" max="100" />
            <small class="form-help">Percentage of total project value</small>
          </div>
          <div class="form-group">
            <label for="min-fee">Minimum Fee ($)</label>
            <Input id="min-fee" @type="number" @value={{this.minimumFee}} placeholder="50.00" step="0.01" min="0" />
            <small class="form-help">Minimum fee regardless of project value</small>
          </div>
        {{/if}}

        {{#if (eq this.feeStructureType "square_footage")}}
          <div class="form-group">
            <label for="fee-per-sqft">Fee per Square Foot ($)</label>
            <Input id="fee-per-sqft" @type="number" @value={{this.feePerSquareFoot}} placeholder="0.25" step="0.01" min="0" />
            <small class="form-help">Fee charged per square foot of construction</small>
          </div>
          <div class="form-group">
            <label for="min-fee">Minimum Fee ($)</label>
            <Input id="min-fee" @type="number" @value={{this.minimumFee}} placeholder="50.00" step="0.01" min="0" />
            <small class="form-help">Minimum fee for small projects</small>
          </div>
        {{/if}}

        {{#if (eq this.feeStructureType "tiered")}}
          <div class="tiered-fees-section">
            <label>Fee Tiers</label>
            <div class="fee-tiers">
              {{#each this.feeTiers as |tier index|}}
                <div class="fee-tier">
                  <div class="tier-inputs">
                    <div class="form-group">
                      <label>From ($)</label>
                      <Input @type="number" @value={{tier.minValue}} placeholder="0" step="0.01" min="0" {{on "input" (fn this.updateTierMinValue index)}} />
                    </div>
                    <div class="form-group">
                      <label>To ($)</label>
                      <Input @type="number" @value={{tier.maxValue}} placeholder="10000" step="0.01" min="0" {{on "input" (fn this.updateTierMaxValue index)}} />
                    </div>
                    <div class="form-group">
                      <label>Fee ($)</label>
                      <Input @type="number" @value={{tier.fee}} placeholder="100.00" step="0.01" min="0" {{on "input" (fn this.updateTierFee index)}} />
                    </div>
                    <button type="button" class="btn btn-outline btn-sm" {{on "click" (fn this.removeTier index)}}>Remove</button>
                  </div>
                </div>
              {{/each}}
              <button type="button" class="btn btn-outline" {{on "click" this.addTier}}>
                <span class="btn-icon">+</span>
                Add Tier
              </button>
            </div>
            <small class="form-help">Create fee tiers based on project value ranges</small>
          </div>
        {{/if}}

        <div class="form-group">
          <label for="processing-time">Processing Time (days)</label>
          <Input id="processing-time" @type="number" @value={{this.processingTime}} placeholder="14" min="1" />
          <small class="form-help">Typical time to process applications</small>
        </div>
      </div>

      <div class="form-group">
        <label for="permit-description">Detailed Description</label>
        <Textarea id="permit-description" @value={{this.permitDescription}} placeholder="Provide detailed information about when this permit is required..." rows="4" />
      </div>

      <div class="form-settings">
        <div class="form-group checkbox-group">
          <label class="checkbox-label">
            <Input @type="checkbox" @checked={{this.requiresInspection}} />
            <span class="checkbox-text">Requires Inspection</span>
          </label>
          <small class="form-help">Check if this permit type requires on-site inspections</small>
        </div>

        <div class="form-group checkbox-group">
          <label class="checkbox-label">
            <Input @type="checkbox" @checked={{this.isActive}} />
            <span class="checkbox-text">Active</span>
          </label>
          <small class="form-help">Uncheck to deactivate this permit type</small>
        </div>
      </div>
    </div>

    {{! Step 3: Review Departments }}
    <div class="form-section">
      <div class="section-header">
        <h2>3. Review Departments</h2>
        <p>Select which departments need to review this permit type before approval</p>
      </div>

      <div class="departments-selection">
        <div class="departments-grid">
          {{#each this.availableDepartments as |department|}}
            <div class="department-card {{if (this.isDepartmentSelected department.id) 'selected'}}" {{on "click" (fn this.toggleDepartment department.id)}}>
              <div class="department-header">
                <span class="department-icon">{{department.icon}}</span>
                <div class="department-info">
                  <h4 class="department-name">{{department.name}}</h4>
                  <p class="department-description">{{department.description}}</p>
                </div>
                <div class="selection-indicator">
                  {{#if (this.isDepartmentSelected department.id)}}
                    <span class="selected-icon">✓</span>
                  {{else}}
                    <span class="unselected-icon">+</span>
                  {{/if}}
                </div>
              </div>
            </div>
          {{/each}}
        </div>
      </div>

      {{! Department Checklists }}
      {{#if this.selectedDepartments.length}}
        <div class="department-checklists-section">
          <h3>Department Review Checklists</h3>
          <p>Configure specific checklist items that reviewers must complete before approval.</p>
          
          {{#each this.selectedDepartments as |departmentId|}}
            {{#let (this.getDepartmentInfo departmentId) as |department|}}
              <div class="department-checklist-card">
                <div class="checklist-header">
                  <span class="department-icon">{{department.icon}}</span>
                  <h4>{{department.name}} Checklist</h4>
                </div>
                
                <div class="checklist-items">
                  {{#each (this.getDepartmentChecklist departmentId) as |item index|}}
                    <div class="checklist-item">
                      <div class="item-inputs">
                        <div class="form-group">
                          <Input 
                            @value={{item.label}} 
                            placeholder="Enter checklist item..." 
                            {{on "input" (fn this.updateChecklistItem departmentId index "label")}}
                          />
                        </div>
                        <label class="checkbox-label">
                          <Input 
                            @type="checkbox" 
                            @checked={{item.required}} 
                            {{on "change" (fn this.updateChecklistItem departmentId index "required")}}
                          />
                          <span class="checkbox-text">Required</span>
                        </label>
                        <button 
                          type="button" 
                          class="btn btn-outline btn-sm" 
                          {{on "click" (fn this.removeChecklistItem departmentId index)}}
                        >
                          Remove
                        </button>
                      </div>
                    </div>
                  {{/each}}
                  
                  <button 
                    type="button" 
                    class="btn btn-outline" 
                    {{on "click" (fn this.addChecklistItem departmentId)}}
                  >
                    <span class="btn-icon">+</span>
                    Add Checklist Item
                  </button>
                </div>
              </div>
            {{/let}}
          {{/each}}
        </div>
      {{/if}}
    </div>

    {{! Step 4: Application Questions }}
    <div class="form-section">
      <div class="section-header">
        <h2>4. Application Questions</h2>
        <p>Customize the information you collect from applicants</p>
      </div>

      <div class="questions-section">
        <div class="questions-header">
          <div class="questions-tabs">
            <button type="button" class="tab-btn {{if (eq this.activeQuestionTab 'default') 'active'}}" {{on "click" (fn this.setQuestionTab 'default')}}>
              Default Questions
            </button>
            <button type="button" class="tab-btn {{if (eq this.activeQuestionTab 'custom') 'active'}}" {{on "click" (fn this.setQuestionTab 'custom')}}>
              Custom Questions
            </button>
          </div>
          {{#if (eq this.activeQuestionTab 'custom')}}
            <button type="button" class="btn btn-outline" {{on "click" this.addCustomQuestion}}>
              <span class="btn-icon">➕</span>
              Add Question
            </button>
          {{/if}}
        </div>

        {{#if (eq this.activeQuestionTab 'default')}}
          <div class="default-questions">
            {{#if this.defaultQuestions.length}}
              <p class="section-note">These are the current default questions for this permit type. You can remove any that don't apply.</p>
              
              {{#each this.defaultQuestions as |question|}}
                <div class="question-item {{if question.isRequired 'required'}}">
                  <div class="question-header">
                    <div class="question-info">
                      <span class="question-type-badge">{{question.type}}</span>
                      <span class="question-label">{{question.label}}</span>
                      {{#if question.isRequired}}
                        <span class="required-badge">Required</span>
                      {{/if}}
                    </div>
                    <div class="question-actions">
                      <button type="button" class="btn-icon" {{on "click" (fn this.toggleDefaultQuestion question)}} title="{{if question.isIncluded 'Remove' 'Include'}} question">
                        {{#if question.isIncluded}}
                          <span class="remove-icon">✓</span>
                        {{else}}
                          <span class="add-icon">+</span>
                        {{/if}}
                      </button>
                    </div>
                  </div>
                  
                  {{#if question.description}}
                    <p class="question-description">{{question.description}}</p>
                  {{/if}}
                  
                  {{#if question.options}}
                    <div class="question-options">
                      <span class="options-label">Options:</span>
                      {{#each question.options as |option|}}
                        <span class="option-tag">{{option}}</span>
                      {{/each}}
                    </div>
                  {{/if}}
                </div>
              {{/each}}
            {{else}}
              <div class="no-default-questions">
                <div class="empty-icon">📋</div>
                <h3>No Default Questions</h3>
                <p>This permit type doesn't have any predefined default questions.</p>
              </div>
            {{/if}}
          </div>
        {{/if}}

        {{#if (eq this.activeQuestionTab 'custom')}}
          <div class="custom-questions">
            {{#if this.customQuestions.length}}
              {{#each this.customQuestions as |question index|}}
                <div class="custom-question-form">
                  <div class="question-form-header">
                    <h4>Question {{add index 1}}</h4>
                    <button type="button" class="btn-icon danger" {{on "click" (fn this.removeCustomQuestion index)}} title="Remove question">
                      <span class="remove-icon">🗑️</span>
                    </button>
                  </div>

                  <div class="form-grid">
                    <div class="form-group">
                      <label>Question Type</label>
                      <select class="form-select" value={{question.type}} {{on "change" (fn this.updateQuestionType index)}}>
                        <option value="text">Short Text</option>
                        <option value="textarea">Long Text</option>
                        <option value="number">Number</option>
                        <option value="select">Dropdown</option>
                        <option value="radio">Multiple Choice</option>
                        <option value="checkbox">Checkboxes</option>
                        <option value="date">Date</option>
                        <option value="file">File Upload</option>
                      </select>
                    </div>

                    <div class="form-group">
                      <label>Question Label</label>
                      <Input @value={{question.label}} placeholder="Enter your question" {{on "input" (fn this.updateQuestionLabel index)}} />
                    </div>
                  </div>

                  <div class="form-group">
                    <label>Description (optional)</label>
                    <Textarea @value={{question.description}} placeholder="Provide additional context or instructions" rows="2" {{on "input" (fn this.updateQuestionDescription index)}} />
                  </div>

                  {{#if (this.questionTypeNeedsOptions question.type)}}
                    <div class="form-group">
                      <label>Options</label>
                      <div class="options-builder">
                        {{#each question.options as |option optionIndex|}}
                          <div class="option-item">
                            <Input @value={{option}} placeholder="Option {{add optionIndex 1}}" {{on "input" (fn this.updateQuestionOption index optionIndex)}} />
                            <button type="button" class="btn-icon" {{on "click" (fn this.removeQuestionOption index optionIndex)}} title="Remove option">
                              <span class="remove-icon">×</span>
                            </button>
                          </div>
                        {{/each}}
                        <button type="button" class="btn btn-outline btn-sm" {{on "click" (fn this.addQuestionOption index)}}>
                          <span class="btn-icon">+</span>
                          Add Option
                        </button>
                      </div>
                    </div>
                  {{/if}}

                  <div class="question-settings">
                    <label class="checkbox-label">
                      <Input @type="checkbox" @checked={{question.isRequired}} {{on "change" (fn this.toggleQuestionRequired index)}} />
                      <span class="checkbox-text">Required Question</span>
                    </label>
                  </div>
                </div>
              {{/each}}
            {{else}}
              <div class="empty-questions">
                <div class="empty-icon">❓</div>
                <h3>No Custom Questions</h3>
                <p>Add custom questions to collect specific information for this permit type.</p>
                <button type="button" class="btn btn-primary" {{on "click" this.addCustomQuestion}}>
                  <span class="btn-icon">➕</span>
                  Add Your First Question
                </button>
              </div>
            {{/if}}
          </div>
        {{/if}}
      </div>
    </div>

    {{! Form Actions }}
    <div class="form-actions">
      <button type="button" class="btn btn-secondary" {{on "click" this.cancelForm}}>
        Cancel
      </button>
      <button type="submit" class="btn btn-primary" disabled={{this.isSubmitting}}>
        {{#if this.isSubmitting}}
          <span class="btn-spinner"></span>
          Updating...
        {{else}}
          <span class="btn-icon">💾</span>
          Update Permit Type
        {{/if}}
      </button>
    </div>
  </form>

  {{#if this.errorMessage}}
    <div class="error-alert">
      <span class="error-icon">⚠️</span>
      <span class="error-text">{{this.errorMessage}}</span>
    </div>
  {{/if}}
</div>

{{! Form initialization handled in route's setupController method }}